#!/usr/bin/env bash

# mx-share-session is a session with utilities that is linked to every tmux session I run

function try_open() {
    if (type -p "$1" > /dev/null); then
        tmux new-window -t '_shared' -a -n "$1"
        tmux set-option -t '_shared' allow-rename off
        tmux send-keys -t '_shared' "$1 $2" C-m
    else
        echo "$1 was not found in your pathâ€¦"
    fi
}

function create_shared_session() {
    # Create the session and the Log & Notes Window
    local twidth theight
    twidth=$(tput cols)
    theight=$(tput lines)
    tmux new-session -d -s '_shared' -n 'Log & Notes' -x $twidth -y $theight
    tmux set-option allow-rename off
    tmux send-keys -t '_shared' 'e ~/_log.md -c "silent! \!tmux wait-for -S log-editor"' C-m
    tmux wait-for log-editor
    tmux send-keys -t '_shared' ":vs ~/_notes.md | silent! !tmux wait-for -S notes-editor" C-m
    tmux wait-for notes-editor
    tmux send-keys -t '_shared' C-w h ":sp ~/_todo.md" C-m
    # Open other programs
    try_open 'weechat'
}

function create() {
    if ! (tmux has-session -t '_shared' > /dev/null 2>&1); then
        create_shared_session
    fi
    tmux wait-for -S shared-create
}

function link() {
    if (tmux has-session -t '_shared' > /dev/null 2>&1); then
        tmux link-window -s '_shared:Log & Notes' -t "${1}:0" -d
        tmux link-window -s '_shared:weechat' -t "${1}:9" -d
    fi
    tmux wait-for -S shared-link
}

case "$1" in
    link)
        link "$2"
        ;;
    create)
        create
        ;;
esac
