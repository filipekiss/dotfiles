#!/usr/bin/env bash

DIR="${BASH_SOURCE%/*}"
if [[ ! -d "$DIR" ]]; then DIR="$PWD"; fi
source "${DIR}/utils/utils"

create_branch_from_ticket() {
  local TICKET="$1"

  [[ -z ${TICKET} || ! $(is_ticket_valid "$TICKET") ]] && ok=0 || ok=1
  while [ $ok = 0 ]
  do
    e_inline "Please, inform the ticket code (ex: SS-1234): "
    read -r TICKET_INPUT
    [[ $(is_ticket_valid "${TICKET_INPUT}")  ]] && ok=1 && TICKET=${TICKET_INPUT} || e_error "Please, fill in the ticket following the pattern SS-1234"
  done
  e_info "Creating branch ${PURPLE}${TICKET}${WHITE} from ${PURPLE}master${RESET}"
  git branch ${TICKET} && \
  e_info "Switching to branch ${TICKET}"
  git checkout ${TICKET}
}

is_ticket_valid() {
  local TICKET="$1"
  if [[ ${TICKET} =~ ^([A-Z]{2})-([0-9]{1,})$ ]]; then
    echo "true"
    return
  fi
  echo ""
}

go_to_branch() {
  local TICKET="$1"

  local BRANCH_EXISTS=$(git rev-parse --verify ${TICKET} 2> /dev/null)

  [[ ${BRANCH_EXISTS} ]] && e_success "Branch found: ${PURPLE}${TICKET}" & git checkout "${TICKET}" || create_branch_from_ticket "${TICKET}"
}

main() {
  local TICKET="$1"

  REPO_NAME=$(basename `git rev-parse --show-toplevel`)

  [[ ${REPO_NAME} != *"saraiva"* ]] && e_warning "This doesn't seem to be the Saraiva repo. Aborting..." && exit 1

  e_info "Changing branch to ${PURPLE}master${RESET}" && \
  git checkout master > /dev/null 2>&1 && \
  e_info "Fetching latest changes" && \
  git pull --rebase origin master > /dev/null 2>&1 && \
  e_success "${PURPLE}master${GREEN} updated"

  go_to_branch "${TICKET}"
}

main $@
