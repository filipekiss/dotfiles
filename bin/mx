#!/usr/bin/env bash

# mx
# version 1.0

# Contributors:
#   Wynn Netherland - https://github.com/pengwynn
#   Adam Jahnke - https://github.com/adamyonk
#   Filipe Kiss - https://github.com/filipekiss

# Usage:
#   mx [session]

# To 'auto-launch' projects, you'll need a $PROJECTS dir where you keep code
# sorted like so: $PROJECTS/<org or user>/<repo>.
# So, a typical workflow would look like:
#   $ hub clone pengwynn/octonaut $PROJECTS/pengwynn/octonaut
#   $ mx octonaut

# If `mx` is called with a <session> name, and there is no valid repo inside
# $PROJECTS, a new tmux session will be initialized in the current working
# directory with a name of <session>

# If the target directory has a .tmux file, that file will be executed
# (and sent the <session> name as the first argument) instead of the default
# window setup (explained below). An example .tmux file may look like
# so:
#   #!/usr/bin/env sh
#   SESSION="$1"
#   cd ~/.dotfiles
#   tmux new-session -s "$SESSION" -n editor -d
#   tmux send-keys 'e' C-m ':CtrlP' C-m
#   tmux select-window -t "$SESSION":1

# If there is no .tmux file, the default window setup is as follows:
# editor/shell  - runs $EDITOR right away and a new shell in a 50/50 split
# shell - runs the shell in a second window, just in case
# shared windows - attach windows created for the _shared session

set -e
source dotfiles "source"


if [ -z "$1" ]; then
  SESSION="${PWD##*/}"
else
  SESSION="$1"
fi

# tmux 1.9a+ doesn't like .'s in session names
SESSION="${SESSION//./_}"
[[ "$SESSION" == *'dotfiles' ]] && SESSION='dotfiles'

mx-shared-session create&

if ! (tmux has-session -t "$SESSION" > /dev/null 2>&1); then
    WORKINGDIR=""

    twidth=$(tput cols)
    theight=$(tput lines)

    e_set_inline
    if [[ "$SESSION" == 'dotfiles' && -d "$HOME/.dotfiles" ]]; then
        e_info "Using dotfiles settings"
        WORKINGDIR="${HOME}/.dotfiles"
    elif [ -d "${HOME}/${SESSION}" ]; then
        e_info "Found project at ${HOME}/${SESSION}"
        WORKINGDIR="$HOME/$SESSION"
    elif [ -d "$PROJECTS"/"$SESSION"/"$2" ]; then
        e_info "Found project at ${HOME}/${SESSION}/$2"
        WORKINGDIR="$PROJECTS"/"$SESSION"/"$2"
    elif [ -d "$PROJECTS"/"$SESSION" ]; then
        e_info "Found project at ${PROJECTS}/${SESSION}"
        WORKINGDIR="$PROJECTS"/"$SESSION"
    else
        e_info "Using current directory: $PWD"
        WORKINGDIR="$PWD"
    fi

    tmux new-session -s "$SESSION" -n editor -d -c $WORKINGDIR -x $twidth -y $theight
    # If there's a start script and it has +x permissions, execute it
    e_reset_line
    e_set_inline
    if  [ -x "${WORKINGDIR}/start" ]; then
        e_info "Running start script at ${WORKINGDIR}/start"
        tmux send-keys -t "$SESSION" "${WORKINGDIR}/start" C-m
    # Else, run the default config: Split 80/20 with editor on left and shell on $PWD on right
    else
        e_info "Setting up default workspace…"
        tmux send-keys -t "$SESSION" "$EDITOR" C-m
        tmux split-window -h -p 20 -c $WORKINGDIR -t "$SESSION"
        tmux new-window -d -n 'shell' -t "$SESSION"
    fi

    tmux wait-for shared-create
    e_reset_line
    e_set_inline
    e_info "Linking shared windows…"
    mx-shared-session link $SESSION
    tmux select-window -t 1
    tmux select-pane -t 0
fi

if [ -z "$TMUX" ]; then
  tmux attach -t "$SESSION"
else
  tmux switch-client -t "$SESSION"
fi
